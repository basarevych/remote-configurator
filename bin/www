#!/usr/bin/env node

"use strict";

const http = require("http");
const path = require("path");
const fs = require("fs-extra");
const App = require("../api/app");

const root = path.join.bind(path, path.resolve(__dirname), "..");
process.chdir(root());

let app = new App();

let params = [app.express];
if (app.config.appSslKey && app.config.appSslCert) {
  let key =
    app.config.appSslKey[0] === "/"
      ? app.config.appSslKey
      : path.join(__dirname, "..", app.config.appSslKey);
  let cert =
    app.config.appSslCert[0] === "/"
      ? app.config.appSslCert
      : path.join(__dirname, "..", app.config.appSslCert);
  params.unshift({
    key: fs.readFileSync(key),
    cert: fs.readFileSync(cert)
  });
}
let server = http.createServer(...params);

app
  .init({ server })
  .then(() => {
    server.listen(app.config.appPort, app.config.appHost);
    server.on("error", onError);
    server.once("listening", onListening);
  })
  .catch(error => {
    console.error(error);
    process.exit(1);
  });

/**
 * Event listener for HTTP server "error" event.
 * @param {Error} error
 */
function onError(error) {
  if (error.syscall !== "listen") throw error;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case "EACCES":
      console.error(`Port ${app.config.appPort} requires elevated privileges`);
      process.exit(1);
      break;
    case "EADDRINUSE":
      console.error(`Port ${app.config.appPort} is already in use`);
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  let address = server.address();
  console.log(`> Server is listening on ${address.address}:${address.port}`);
  console.log(`> Serving ${app.config.appOrigins.join(", ")}`);
}
